name: Auto Release on PR Merge

on:
  pull_request:
    types: [closed]

jobs:
  create-tag:
    name: Create Release Tag
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'auto-release')
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.AUTOMATION_APP_ID }}
          private-key: ${{ secrets.AUTOMATION_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Extract version from branch name
        id: extract_version
        run: |
          branch_name="${{ github.event.pull_request.head.ref }}"
          echo "Branch name: $branch_name"

          # Extract version (release/vX.Y.Z -> X.Y.Z)
          if [[ $branch_name =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?)$ ]]; then
            version="${BASH_REMATCH[1]}"
            echo "version=$version" >> $GITHUB_OUTPUT
            echo "‚úÖ Version: $version"
          else
            echo "‚ùå Error: Invalid branch name format, expected release/vX.Y.Z"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          version="${{ steps.extract_version.outputs.version }}"
          if git rev-parse "v$version" >/dev/null 2>&1; then
            echo "‚ùå Error: tag v$version already exists"
            exit 1
          fi
          echo "‚úÖ Tag v$version does not exist, ready to create"

      - name: Create and push tag
        env:
          VERSION: ${{ steps.extract_version.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"

          echo "‚úÖ Created and pushed tag: v${VERSION}"
          echo "üîÑ This will trigger auto-release.yml workflow"
