name: Auto Release on PR Merge

on:
  pull_request:
    types: [closed]

jobs:
  auto-release:
    name: Auto Release
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'auto-release')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from branch name
        id: extract_version
        run: |
          branch_name="${{ github.event.pull_request.head.ref }}"
          echo "分支名: $branch_name"

          # 提取版本号 (release/vX.Y.Z -> X.Y.Z)
          if [[ $branch_name =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?)$ ]]; then
            version="${BASH_REMATCH[1]}"
            echo "version=$version" >> $GITHUB_OUTPUT
            echo "✅ 版本号: $version"
          else
            echo "❌ 错误: 分支名格式不正确，应为 release/vX.Y.Z"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          version="${{ steps.extract_version.outputs.version }}"
          if git rev-parse "v$version" >/dev/null 2>&1; then
            echo "❌ 错误: tag v$version 已存在"
            exit 1
          fi
          echo "✅ tag v$version 不存在，可以创建"

      - name: Create and push tag
        env:
          VERSION: ${{ steps.extract_version.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "v${VERSION}" -m "Release v${VERSION}

          Automatically created by auto-release workflow

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

          git push origin "v${VERSION}"
          echo "✅ 已创建并推送 tag: v${VERSION}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.extract_version.outputs.version }}
        run: |
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --generate-notes

          echo "✅ Release v${VERSION} 已创建"

      - name: Get release URL
        id: get_release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.extract_version.outputs.version }}
        run: |
          release_url=$(gh release view "v${VERSION}" --json url -q .url)
          echo "release_url=$release_url" >> $GITHUB_OUTPUT
          echo "✅ Release URL: $release_url"

      - name: Send success notification to Feishu
        if: success()
        continue-on-error: true
        env:
          VERSION: ${{ steps.extract_version.outputs.version }}
        run: |
          python3 scripts/feishu-notify.py \
            --webhook "${{ secrets.FEISHU_RELEASE_WEBHOOK }}" \
            --repo "${{ github.event.repository.name }}" \
            --version "${VERSION}" \
            --release-url "${{ steps.get_release.outputs.release_url }}" \
            --status "success"

      - name: Send failure notification to Feishu
        if: failure()
        continue-on-error: true
        env:
          VERSION: ${{ steps.extract_version.outputs.version }}
        run: |
          python3 scripts/feishu-notify.py \
            --webhook "${{ secrets.FEISHU_RELEASE_WEBHOOK }}" \
            --repo "${{ github.event.repository.name }}" \
            --version "${VERSION}" \
            --release-url "${{ github.event.pull_request.html_url }}" \
            --status "failed"
